package wtf.demise.features.modules.impl.exploit;

import lombok.Getter;
import net.minecraft.client.gui.GuiDownloadTerrain;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.network.INetHandler;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C07PacketPlayerDigging;
import net.minecraft.network.play.client.C0BPacketEntityAction;
import net.minecraft.network.play.client.C0FPacketConfirmTransaction;
import net.minecraft.network.play.server.*;
import net.minecraft.util.BlockPos;
import net.minecraft.util.EnumFacing;
import org.apache.commons.lang3.Range;
import wtf.demise.Demise;
import wtf.demise.events.annotations.EventTarget;
import wtf.demise.events.impl.misc.WorldChangeEvent;
import wtf.demise.events.impl.packet.PacketEvent;
import wtf.demise.events.impl.player.MotionEvent;
import wtf.demise.events.impl.player.UpdateEvent;
import wtf.demise.features.modules.Module;
import wtf.demise.features.modules.ModuleInfo;
import wtf.demise.features.modules.impl.combat.TimerRange;
import wtf.demise.features.modules.impl.player.Scaffold;
import wtf.demise.features.values.impl.BoolValue;
import wtf.demise.features.values.impl.MultiBoolValue;
import wtf.demise.utils.packet.BlinkComponent;
import wtf.demise.utils.packet.PacketUtils;
import wtf.demise.utils.player.PlayerUtils;

import java.util.Arrays;
import java.util.concurrent.ConcurrentLinkedDeque;
import java.util.concurrent.CopyOnWriteArrayList;

@ModuleInfo(name = "Disabler", description = "Disables parts of anticheats.")
public class Disabler extends Module {
    public final MultiBoolValue options = new MultiBoolValue("Options", Arrays.asList(
            new BoolValue("Verus combat", false),
            new BoolValue("Post", false),
            new BoolValue("Vulcan", false),
            new BoolValue("Balance", false),
            new BoolValue("Saved balance", false)
    ), this);

    private final BoolValue sprint = new BoolValue("Sprint", false, this, () -> options.isEnabled("Vulcan"));
    private final BoolValue reach = new BoolValue("Reach", false, this, () -> options.isEnabled("Vulcan"));
    private final BoolValue autoClicker = new BoolValue("Auto clicker", false, this, () -> options.isEnabled("Vulcan"));

    private boolean lastResult = false;
    public boolean disabled = false;
    @Getter
    private final CopyOnWriteArrayList<Packet<INetHandler>> storedPackets = new CopyOnWriteArrayList<>();
    @Getter
    private final ConcurrentLinkedDeque<Integer> pingPackets = new ConcurrentLinkedDeque<>();
    public boolean transaction;
    private boolean dispatched;

    @EventTarget
    public void onWorld(WorldChangeEvent e) {
        disabled = false;
    }

    @EventTarget
    public void onUpdate(UpdateEvent e) {
        if (options.isEnabled("Vulcan")) {
            if (mc.thePlayer.isInWater() || mc.thePlayer.isOnLadder() || mc.thePlayer.isDead || mc.currentScreen != null) {
                return;
            }

            if (sprint.get()) {
                PacketUtils.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SPRINTING));
                PacketUtils.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.STOP_SPRINTING));
            }

            if (autoClicker.get() && mc.thePlayer.ticksExisted % 100 == 0) {
                PacketUtils.sendPacket(new C07PacketPlayerDigging(C07PacketPlayerDigging.Action.START_DESTROY_BLOCK, new BlockPos(mc.thePlayer), EnumFacing.UP));
            }

            if (reach.get()) {
                EntityLivingBase target = PlayerUtils.getTarget(7, false);

                if (Range.between(2.9, 6.0).contains(PlayerUtils.getDistanceToEntityBox(target))) {
                    BlinkComponent.blinking = true;
                    dispatched = false;

                    if (mc.thePlayer.ticksExisted % 2 == 0) {
                        BlinkComponent.dispatch(true);
                        dispatched = true;
                    }
                } else if (!dispatched) {
                    BlinkComponent.dispatch(true);
                    dispatched = true;
                }
            }
        }

        if (options.isEnabled("Saved balance")) {
            mc.timer.timerSpeed = TimerRange.working ? 1 : 0.99f;
        }
    }

    @EventTarget
    public void onMotion(MotionEvent event) {
        if (options.isEnabled("Post")) {
            if (event.isPre() && !getPost()) {
                processPackets();
            }
        }
    }

    @EventTarget
    public void onPacket(PacketEvent e) {
        if (mc.thePlayer == null) return;

        if (options.isEnabled("Verus combat")) {
            if (e.getPacket() instanceof S32PacketConfirmTransaction) {
                e.setCancelled(true);
                sendPacketNoEvent(new C0FPacketConfirmTransaction((transaction ? 1 : -1), (short) (transaction ? 1 : -1), transaction));
                transaction = !transaction;
            }
        }

        if (options.isEnabled("Balance")) {
            if (e.getPacket() instanceof C03PacketPlayer packet) {
                if (!packet.isMoving() && !packet.getRotating() && !mc.thePlayer.isUsingItem() && !Demise.INSTANCE.getModuleManager().getModule(Scaffold.class).isEnabled()) {
                    e.setCancelled(true);
                    TimerRange.balance--;
                }
            }
        }
    }

    public boolean postDelay(Packet<?> packet) {
        if (mc.thePlayer == null && !isEnabled(this.getClass())) {
            return false;
        }
        if (packet instanceof S12PacketEntityVelocity velocityPacket) {
            return velocityPacket.getEntityID() == mc.thePlayer.getEntityId();
        } else return
                packet instanceof S32PacketConfirmTransaction ||
                packet instanceof S22PacketMultiBlockChange ||
                packet instanceof S04PacketEntityEquipment ||
                packet instanceof S08PacketPlayerPosLook ||
                packet instanceof S06PacketUpdateHealth ||
                packet instanceof S23PacketBlockChange ||
                packet instanceof S27PacketExplosion ||
                packet instanceof S00PacketKeepAlive ||
                packet instanceof S0FPacketSpawnMob ||
                packet instanceof S14PacketEntity;
    }

    public void processPackets() {
        if (options.isEnabled("Post")) {
            if (!storedPackets.isEmpty()) {
                for (Packet<INetHandler> packet : storedPackets) {
                    PacketEvent event = new PacketEvent(packet, PacketEvent.State.INCOMING);

                    INSTANCE.getEventManager().call(event);

                    if (!event.isCancelled()) {
                        packet.processPacket(mc.getNetHandler());
                    }
                }
                storedPackets.clear();
            }
        }
    }

    public boolean getPost() {
        boolean result = mc.thePlayer != null && mc.thePlayer.isEntityAlive() && mc.thePlayer.ticksExisted >= 10 && !(mc.currentScreen instanceof GuiDownloadTerrain);
        if (this.lastResult && !result) {
            this.lastResult = false;
            mc.addScheduledTask(this::processPackets);
        }
        return this.lastResult = result;
    }
}