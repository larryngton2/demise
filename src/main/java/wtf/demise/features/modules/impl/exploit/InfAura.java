package wtf.demise.features.modules.impl.exploit;

import com.viaversion.viaversion.api.protocol.version.ProtocolVersion;
import de.florianmichael.vialoadingbase.ViaLoadingBase;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.network.play.client.C02PacketUseEntity;
import wtf.demise.Demise;
import wtf.demise.events.annotations.EventTarget;
import wtf.demise.events.impl.player.AttackEvent;
import wtf.demise.events.impl.player.UpdateEvent;
import wtf.demise.features.modules.Module;
import wtf.demise.features.modules.ModuleInfo;
import wtf.demise.features.values.impl.SliderValue;
import wtf.demise.utils.math.TimerUtils;
import wtf.demise.utils.packet.PacketUtils;
import wtf.demise.utils.player.PlayerUtils;

@ModuleInfo(name = "InfAura", description = "Attacks players from far away.")
public class InfAura extends Module {
    private final SliderValue attackDelay = new SliderValue("Attack delay", 50, 0, 2000, 1, this);
    private final SliderValue range = new SliderValue("Range", 500, 10, 500, 1, this);

    private final TimerUtils attackTimer = new TimerUtils();

    @EventTarget
    public void onUpdate(UpdateEvent e) {
        if (attackTimer.hasTimeElapsed(attackDelay.get())) {
            for (EntityPlayer target : mc.theWorld.playerEntities) {
                if (target == mc.thePlayer || PlayerUtils.getDistanceToEntityBox(target) > range.get()) {
                    continue;
                }

                if (ViaLoadingBase.getInstance().getTargetVersion().olderThanOrEqualTo(ProtocolVersion.v1_8)) {
                    mc.thePlayer.swingItem();
                    PacketUtils.sendPacket(new C02PacketUseEntity(target, C02PacketUseEntity.Action.ATTACK));
                } else {
                    PacketUtils.sendPacket(new C02PacketUseEntity(target, C02PacketUseEntity.Action.ATTACK));
                    mc.thePlayer.swingItem();
                }
                Demise.INSTANCE.getEventManager().call(new AttackEvent(target));
            }
        }
    }
}