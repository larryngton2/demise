package wtf.demise.features.modules.impl.exploit;

import net.minecraft.entity.player.PlayerCapabilities;
import net.minecraft.nbt.NBTTagCompound;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C0BPacketEntityAction;
import net.minecraft.network.play.client.C13PacketPlayerAbilities;
import wtf.demise.events.annotations.EventTarget;
import wtf.demise.events.impl.packet.PacketEvent;
import wtf.demise.events.impl.player.UpdateEvent;
import wtf.demise.events.impl.render.Render3DEvent;
import wtf.demise.features.modules.Module;
import wtf.demise.features.modules.ModuleCategory;
import wtf.demise.features.modules.ModuleInfo;
import wtf.demise.features.values.impl.ModeValue;
import wtf.demise.utils.packet.PacketUtils;
import wtf.demise.utils.player.MovementCorrection;
import wtf.demise.utils.player.rotation.OldRotationUtils;

@ModuleInfo(name = "AutoBan", description = "Yeah...", category = ModuleCategory.Exploit)
public class AutoBan extends Module {
    private final ModeValue mode = new ModeValue("Mode", new String[]{"PacketFucker", "InvalidPitch", "Abilities", "Post"}, "PacketFucker", this);

    @EventTarget
    public void onUpdate(UpdateEvent e) {
        if (mode.is("InvalidPitch")) {
            OldRotationUtils.setRotation(new float[]{mc.thePlayer.rotationYaw, 91}, MovementCorrection.None, 180, 180);
        }
    }

    @EventTarget
    public void onRender3D(Render3DEvent e) {
        if (mode.is("Abilities")) {
            sendPacket(new C13PacketPlayerAbilities(createCapabilitiesCopyAndRapeIt()));
        }

        if (mode.is("Post")) {
            PacketUtils.sendPacket(new C0BPacketEntityAction(mc.thePlayer, C0BPacketEntityAction.Action.START_SNEAKING));
        }
    }

    private static PlayerCapabilities createCapabilitiesCopyAndRapeIt() {
        NBTTagCompound capabilitiesNBT = new NBTTagCompound();
        PlayerCapabilities capabilities = new PlayerCapabilities();

        mc.thePlayer.capabilities.writeCapabilitiesToNBT(capabilitiesNBT);
        capabilities.readCapabilitiesFromNBT(capabilitiesNBT);

        capabilities.allowFlying = true;
        capabilities.isFlying = true;
        capabilities.disableDamage = true;
        capabilities.isCreativeMode = true;

        return capabilities;
    }

    @EventTarget
    public void onPacket(PacketEvent e) {
        if (mode.is("PacketFucker")) {
            if (e.getPacket() instanceof C03PacketPlayer.C06PacketPlayerPosLook packet) {
                double x = packet.getPositionX() + (Math.random() - 0.5);
                double y = packet.getPositionY() + (Math.random() - 0.5);
                double z = packet.getPositionZ() + (Math.random() - 0.5);
                float yaw = packet.getYaw();
                float pitch = packet.getPitch();

                C03PacketPlayer.C06PacketPlayerPosLook fuckedPacket = new C03PacketPlayer.C06PacketPlayerPosLook(x, y, z, yaw, pitch, packet.isOnGround());

                e.setCancelled(true);

                PacketUtils.sendPacket(fuckedPacket);
            }
        }
    }
}
